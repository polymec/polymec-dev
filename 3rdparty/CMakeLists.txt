include_directories(${PROJECT_BINARY_DIR}/include)

# Build libgc, the C garbage collector library.
if (NOT EXISTS ${PROJECT_BINARY_DIR}/lib/libgc.a)
  set(GC_CONFIG_OPTS --prefix=${PROJECT_BINARY_DIR} --enable-static --disable-shared --enable-threads=pthreads --disable-gcj-support)
  if (${CMAKE_BUILD_TYPE} STREQUAL "Debug")
    set(GC_CONFIG_OPTS ${GC_CONFIG_OPTS} --enable-gc-debug)
  endif()

  message("Preparing gc...")
  execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/gc ${CMAKE_CURRENT_BINARY_DIR}/gc
                  RESULT_VARIABLE stat)
  if (NOT stat EQUAL 0)
    message(FATAL_ERROR "Copying library source failed.")
  endif()

  message("Configuring gc...")
  execute_process(COMMAND env CC=${CMAKE_C_COMPILER} ./configure ${GC_CONFIG_OPTS}
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/gc
                  OUTPUT_VARIABLE gc_config_log ERROR_VARIABLE gc_config_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/gc_config.log ${gc_config_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/gc_config_errors.log ${gc_config_err})
    message(FATAL_ERROR "Configuration of gc library failed.")
  endif()

  message("Building and installing gc...")
  execute_process(COMMAND make install -j4
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/gc
                  OUTPUT_VARIABLE gc_build_log ERROR_VARIABLE gc_build_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/gc_build.log ${gc_build_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/gc_build_errors.log ${gc_build_err})
    message(FATAL_ERROR "Build of gc library failed.")
  endif()

endif()
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  install(FILES ${PROJECT_BINARY_DIR}/lib/libgc.a DESTINATION lib)
endif()
set(POLYMEC_TP_LIBS gc;${POLYMEC_TP_LIBS})

# Install libarena -- A fast C arena/memory pool implementation.
if (NOT EXISTS ${PROJECT_BINARY_DIR}/include/arena)

  message("Preparing libarena...")
  execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/libarena ${CMAKE_CURRENT_BINARY_DIR}/libarena
                  RESULT_VARIABLE stat)
  if (NOT stat EQUAL 0)
    message(FATAL_ERROR "Copying library source failed.")
  endif()

  message("Copying libarena headers into place...")
  file(GLOB arena_includes "${CMAKE_CURRENT_BINARY_DIR}/libarena/src/*.h")
  execute_process(COMMAND cmake -E make_directory ${PROJECT_BINARY_DIR}/include/arena)
  foreach(inc ${arena_includes})
    execute_process(COMMAND cmake -E copy ${inc} ${PROJECT_BINARY_DIR}/include/arena)
  endforeach()

endif()
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  install(FILES ${CMAKE_CURRENT_BINARY_DIR}/libarena.a DESTINATION lib)
endif()
file(GLOB arena_sources "${CMAKE_CURRENT_BINARY_DIR}/libarena/src/*.c")
add_library(arena ${arena_sources})
set(POLYMEC_TP_LIBS arena;${POLYMEC_TP_LIBS})

# Build zlib for compression.
if (NOT EXISTS ${Z_LIBRARY})
  set(ZLIB_CONFIG_OPTS --prefix=${PROJECT_BINARY_DIR} --static)

  message("Preparing zlib...")
  execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/zlib ${CMAKE_CURRENT_BINARY_DIR}/zlib
                  RESULT_VARIABLE stat)
  if (NOT stat EQUAL 0)
    message(FATAL_ERROR "Copying library source failed.")
  endif()

  message("Configuring zlib...")
  execute_process(COMMAND env CC=${CMAKE_C_COMPILER} ./configure ${ZLIB_CONFIG_OPTS}
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/zlib
                  OUTPUT_VARIABLE zlib_config_log ERROR_VARIABLE zlib_config_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/zlib_config.log ${zlib_config_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/zlib_config_errors.log ${zlib_config_err})
    message(FATAL_ERROR "Configuration of zlib library failed.")
  endif()

  message("Building and installing zlib...")
  execute_process(COMMAND make install -j4
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/zlib
                  OUTPUT_VARIABLE zlib_build_log ERROR_VARIABLE zlib_build_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/zlib_build.log ${zlib_build_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/zlib_build_errors.log ${zlib_build_err})
    message(FATAL_ERROR "Build of zlib library failed.")
  endif()

endif()
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  if (${Z_LIBRARY} STREQUAL "${PROJECT_BINARY_DIR}/lib/libz.a")
    install(FILES ${PROJECT_BINARY_DIR}/lib/libz.a DESTINATION lib)
  endif()
endif()
set(POLYMEC_TP_LIBS z;${POLYMEC_TP_LIBS})

# Build the HDF5 parallel I/O library. 
if (${SILO_LIBRARY} MATCHES "h5")
  if (NOT EXISTS ${HDF5_LIBRARY})
    set(HDF5_CONFIG_OPTS --enable-static --disable-shared --with-zlib=${PROJECT_BINARY_DIR} --disable-dependency-tracking)
    set(HDF5_CONFIG_OPTS ${HDF5_CONFIG_OPTS} --prefix=${PROJECT_BINARY_DIR})
    if (${CMAKE_BUILD_TYPE} STREQUAL "Debug")
      set(HDF5_CONFIG_OPTS ${HDF5_CONFIG_OPTS} --enable-debug=all)
    else()
      set(HDF5_CONFIG_OPTS ${HDF5_CONFIG_OPTS} --enable-production)
    endif()
    if (${HAVE_MPI} EQUAL 1)
      set(HDF5_CONFIG_OPTS ${HDF5_CONFIG_OPTS} --enable-parallel)
    endif()
  
    message("Preparing hdf5...")
    execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/hdf5 ${CMAKE_CURRENT_BINARY_DIR}/hdf5
                    RESULT_VARIABLE stat)
    if (NOT stat EQUAL 0)
      message(FATAL_ERROR "Copying library source failed.")
    endif()

    message("Configuring hdf5...")
    execute_process(COMMAND env CC=${CMAKE_C_COMPILER} FC=${MAKE_Fortran_COMPILER} ./configure ${HDF5_CONFIG_OPTS}
                    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/hdf5
                    OUTPUT_VARIABLE hdf5_config_log ERROR_VARIABLE hdf5_config_err
                    RESULT_VARIABLE stat)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/hdf5_config.log ${hdf5_config_log})
    if (NOT stat EQUAL 0)
      file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/hdf5_config_errors.log ${hdf5_config_err})
      message(FATAL_ERROR "Configuration of hdf5 library failed.")
    endif()

    message("Building and installing hdf5...")
    execute_process(COMMAND make install -j4
                    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/hdf5
                    OUTPUT_VARIABLE hdf5_build_log ERROR_VARIABLE hdf5_build_err
                    RESULT_VARIABLE stat)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/hdf5_build.log ${hdf5_build_log})
    if (NOT stat EQUAL 0)
      file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/hdf5_build_errors.log ${hdf5_build_err})
      message(FATAL_ERROR "Build of hdf5 library failed.")
    endif()
  endif()
  if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
    if (${HDF5_LIBRARY} STREQUAL "${PROJECT_BINARY_DIR}/lib/libhdf5.a")
      install(FILES ${PROJECT_BINARY_DIR}/lib/libhdf5.a DESTINATION lib)
    endif()
  endif()

  set(POLYMEC_TP_LIBS ${HDF5_LIBRARIES};${POLYMEC_TP_LIBS})
endif()

# Install silo with HDF5 support.
if (NOT EXISTS ${SILO_LIBRARY})

  message("Preparing silo...")
  execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/silo ${CMAKE_CURRENT_BINARY_DIR}/silo
                  RESULT_VARIABLE stat)
  if (NOT stat EQUAL 0)
    message(FATAL_ERROR "Copying library source failed.")
  endif()
  execute_process(COMMAND patch -p1 -i ${CMAKE_CURRENT_SOURCE_DIR}/silo.patch 
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/silo
                  OUTPUT_VARIABLE patchy
                  RESULT_VARIABLE stat)
  message("${patchy}")
  if (NOT stat EQUAL 0)
    message(FATAL_ERROR "Patching library source failed.")
  endif()

  message("Configuring silo...")
  set(SILO_CONFIG_OPTS --prefix=${PROJECT_BINARY_DIR})
  set(SILO_CONFIG_OPTS ${SILO_CONFIG_OPTS} --with-hdf5=${PROJECT_BINARY_DIR}/include,${PROJECT_BINARY_DIR}/lib)
  set(SILO_CONFIG_OPTS ${SILO_CONFIG_OPTS} --with-zlib=${PROJECT_BINARY_DIR}/include,${PROJECT_BINARY_DIR}/lib)
  set(SILO_CONFIG_OPTS ${SILO_CONFIG_OPTS} --disable-fortran --without-readline --disable-silex)
  set(SILO_CONFIG_OPTS ${SILO_CONFIG_OPTS} --disable-dependency-tracking)
  set(SILO_CONFIG_OPTS ${SILO_CONFIG_OPTS} --disable-hzip --disable-fpzip)
  if (${CMAKE_BUILD_TYPE} STREQUAL "Release")
    set(SILO_CONFIG_OPTS ${SILO_CONFIG_OPTS} --enable-optimization)
    set(SILO_C_FLAGS -O2)
  else()
    set(SILO_C_FLAGS -g)
  endif()
  set(SILO_ENV CC=${CC} CXX=${CXX} CFLAGS=${SILO_C_FLAGS})
  if (LINUX EQUAL 1)
   # Note: Linux needs -ldl when building Silo because of HDF5's new 
   # Note: dynamically-loaded filters.
   set(SILO_ENV ${SILO_ENV} LIBS=-ldl)
  endif()
  execute_process(COMMAND env ${SILO_ENV} ./configure ${SILO_CONFIG_OPTS}
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/silo
                  OUTPUT_VARIABLE silo_config_log ERROR_VARIABLE silo_config_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/silo_config.log ${silo_config_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/silo_config_errors.log ${silo_config_err})
    message(FATAL_ERROR "Configuration of silo library failed.")
  endif()

  message("Building and installing silo...")
  execute_process(COMMAND make install -j4
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/silo
                  OUTPUT_VARIABLE silo_build_log ERROR_VARIABLE silo_build_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/silo_build.log ${silo_build_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/silo_build_errors.log ${silo_build_err})
    message(FATAL_ERROR "Build of silo library failed.")
  endif()

endif()
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  if (${SILO_LIBRARY} STREQUAL "${PROJECT_BINARY_DIR}/lib/libsiloh5.a")
    install(FILES ${PROJECT_BINARY_DIR}/lib/libsiloh5.a DESTINATION lib)
  endif()
endif()
set(POLYMEC_TP_LIBS ${SILO_LIBRARIES};${POLYMEC_TP_LIBS})

# Build SuperLU, a (serial) direct sparse linear solver library that 
# we will use for preconditioning.
if (NOT EXISTS ${PROJECT_BINARY_DIR}/lib/libsuperlu.a)
  message("Preparing superlu...")
  execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/superlu ${CMAKE_CURRENT_BINARY_DIR}/superlu
                  RESULT_VARIABLE stat)
  if (NOT stat EQUAL 0)
    message(FATAL_ERROR "Copying library source failed.")
  endif()

  message("Adjusting superlu make.inc...")
  file(READ ${CMAKE_CURRENT_BINARY_DIR}/superlu/make.inc superlu_makeinc)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/superlu/make.inc.old ${superlu_makeinc})
  string(REPLACE "gcc" ${CMAKE_C_COMPILER} superlu_makeinc ${superlu_makeinc})
  string(REPLACE "$(HOME)/Dropbox/Codes/SuperLU/SuperLU" ${PROJECT_BINARY_DIR} superlu_makeinc ${superlu_makeinc})
  string(REPLACE "libsuperlu_5.0.a" "libsuperlu.a" superlu_makeinc ${superlu_makeinc})
  if (CMAKE_BUILD_TYPE STREQUAL "Debug")
    if (CMAKE_C_COMPILER_ID STREQUAL "GNU")
      set(superlu_debug_flags "-O0 -g3")
    else()
      set(superlu_debug_flags "-O0 -g")
    endif()
    string(REPLACE "-O3" "${superlu_debug_flags}" superlu_makeinc ${superlu_makeinc})
  endif()
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/superlu/make.inc ${superlu_makeinc})

  message("Building superlu...")
  # Looks like SuperLU wants to be built serially, so no -j4 here.
  execute_process(COMMAND make lib
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/superlu
                  OUTPUT_VARIABLE superlu_build_log ERROR_VARIABLE superlu_build_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/superlu_build.log ${superlu_build_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/superlu_build_errors.log ${superlu_build_err})
    message(FATAL_ERROR "Build of superlu library failed.")
  endif()

#  file(COPY ${CMAKE_CURRENT_BINARY_DIR}/SuperLU_4.3/libsuperlu.a DESTINATION ${PROJECT_BINARY_DIR}/lib)
  file(GLOB includes "${CMAKE_CURRENT_BINARY_DIR}/superlu/SRC/*.h")
  foreach(inc ${includes})
    execute_process(COMMAND cmake -E copy ${inc} ${PROJECT_BINARY_DIR}/include)
  endforeach()
endif()
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  install(FILES ${PROJECT_BINARY_DIR}/lib/libsuperlu.a DESTINATION lib)
endif()
set(POLYMEC_TP_LIBS superlu;${POLYMEC_TP_LIBS})

# Build Sundials, a C library for integrating stiff, nonlinear ODEs and 
# differential-algebraic equations.
if (NOT EXISTS ${PROJECT_BINARY_DIR}/lib/libsundials_cvode.a)
  message("Configuring sundials...")
  execute_process(COMMAND cmake -E make_directory ${CMAKE_CURRENT_BINARY_DIR}/sundials
                  RESULT_VARIABLE stat)
  set(SUNDIALS_CMAKE_OPTS -DCMAKE_INSTALL_PREFIX=${PROJECT_BINARY_DIR} -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DBUILD_SHARED_LIBS=OFF -DBUILD_STATIC_LIBS=ON -DCMAKE_C_FLAGS=${CMAKE_C_FLAGS} -DEXAMPLES_ENABLE=OFF -DSUNDIALS_PRECISION=${POLYMEC_PRECISION})
  if (HAVE_MPI EQUAL 1)
    set(SUNDIALS_CMAKE_OPTS ${SUNDIALS_CMAKE_OPTS} -DMPI_ENABLE=ON -DMPI_MPICC=${CMAKE_C_COMPILER})
  else()
    set(SUNDIALS_CMAKE_OPTS ${SUNDIALS_CMAKE_OPTS} -DMPI_ENABLE=OFF)
  endif()
  execute_process(COMMAND cmake ${SUNDIALS_CMAKE_OPTS} ${CMAKE_CURRENT_SOURCE_DIR}/sundials
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/sundials
                  OUTPUT_VARIABLE sundials_config.log
                  RESULT_VARIABLE stat)
  message("Building and installing sundials...")
  execute_process(COMMAND make install -j4
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/sundials
                  OUTPUT_VARIABLE sundials_build_log ERROR_VARIABLE sundials_build_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/sundials_build.log ${sundials_build_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/sundials_build_errors.log ${sundials_build_err})
    message(FATAL_ERROR "Build of sundials library failed.")
  endif()
endif()
if (HAVE_MPI EQUAL 0)
  set (NVEC_LIBS nvecserial)
else()
  set (NVEC_LIBS nvecparallel;nvecserial)
endif()
foreach(component arkode;cvode;cvodes;ida;idas;kinsol;${NVEC_LIBS})
  list(APPEND SUNDIALS_LIBS sundials_${component})
  if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
    install(FILES ${PROJECT_BINARY_DIR}/lib/libsundials_${component}.a DESTINATION lib)
  endif()
endforeach()
set(POLYMEC_TP_LIBS ${SUNDIALS_LIBS};${POLYMEC_TP_LIBS})

# Build lua, a simple interpreted language library.
if (NOT EXISTS ${PROJECT_BINARY_DIR}/lib/liblua.a)
  if (${APPLE})
    set(LUA_ARCH macosx)
  else() 
    set(LUA_ARCH generic)
  endif()
  message("Preparing lua...")
  execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/lua ${CMAKE_CURRENT_BINARY_DIR}/lua
                  RESULT_VARIABLE stat)
  if (NOT stat EQUAL 0)
    message(FATAL_ERROR "Copying library source failed.")
  endif()

  message("Adjusting lua Makefile...")
  file(READ ${CMAKE_CURRENT_BINARY_DIR}/lua/src/Makefile lua_makefile)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/lua/src/Makefile.old ${lua_makefile})
  string(REPLACE "gcc" ${CMAKE_C_COMPILER} lua_makefile ${lua_makefile})
  string(REPLACE "MYCFLAGS=" "MYCFLAGS=-fPIC ${CMAKE_C_FLAGS}" lua_makefile ${lua_makefile})
  string(REPLACE "MYLDFLAGS=" "MYLDFLAGS=${CMAKE_EXE_LINKER_FLAGS}" lua_makefile ${lua_makefile})
  if (CMAKE_BUILD_TYPE STREQUAL "Debug")
    string(REPLACE "-O2 -Wall" "${CMAKE_C_FLAGS} -g3" lua_makefile ${lua_makefile})
  endif()
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/lua/src/Makefile ${lua_makefile})

  message("Building lua...")
  execute_process(COMMAND make ${LUA_ARCH}
                  WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/lua
                  OUTPUT_VARIABLE lua_build_log ERROR_VARIABLE lua_build_err
                  RESULT_VARIABLE stat)
  file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/lua_build.log ${lua_build_log})
  if (NOT stat EQUAL 0)
    file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/lua_build_errors.log ${lua_build_err})
    message(FATAL_ERROR "Build of lua library failed.")
  endif()

endif()
file(GLOB lua_includes "${CMAKE_CURRENT_BINARY_DIR}/lua/src/*.h")
if (NOT EXISTS ${PROJECT_BINARY_DIR}/lib/liblua.a)
  file(COPY ${CMAKE_CURRENT_BINARY_DIR}/lua/src/liblua.a DESTINATION ${PROJECT_BINARY_DIR}/lib)
  foreach(inc ${lua_includes})
    execute_process(COMMAND cmake -E copy ${inc} ${PROJECT_BINARY_DIR}/include)
  endforeach()
endif()
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  install(FILES ${PROJECT_BINARY_DIR}/lib/liblua.a DESTINATION lib)
endif()
set(POLYMEC_TP_LIBS lua;${POLYMEC_TP_LIBS})
#set(POLYMEC_TP_INCDIRS ${POLYMEC_TP_INCDIRS};${PROJECT_BINARY_DIR}/include)

# Build jrs_predicates, Jonathan Richard Shewchuk's (public domain) library 
# for arbitrary-precision geometric predicates. 
# Since random() is not part of the C standard, we can't lean on it in general.
add_library(jrs_predicates jrs_predicates/predicates.c)
if (LINUX EQUAL 1)
  # On Linux, rand() and random() are the same.
  set_target_properties(jrs_predicates PROPERTIES COMPILE_FLAGS "-Drandom=rand")
endif()
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  install(TARGETS jrs_predicates DESTINATION lib)
endif()
set(POLYMEC_TP_LIBS jrs_predicates;${POLYMEC_TP_LIBS})

# Build cmockery, a C unit testing library.
add_library(cmockery cmockery/cmockery.c)
set_target_properties(cmockery PROPERTIES COMPILE_FLAGS "-Wno-int-to-pointer-cast -Wno-pointer-to-int-cast")
file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/cmockery/cmockery.h DESTINATION ${PROJECT_BINARY_DIR}/include)
if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
  install(TARGETS cmockery DESTINATION lib)
endif()

# If we're building a parallel code, build INRIA's Scotch library.
if (HAVE_MPI EQUAL 1)
  if (NOT EXISTS ${PROJECT_BINARY_DIR}/lib/libscotch.a)
    find_program(FLEX flex)
    find_program(BISON bison)

    # Scotch is a little funky -- it has empty structs when built without 
    # threading support (and uses non-standard threading mechanisms like 
    # pthread barriers when built with threading support!). So we have 
    # to be a little more accommodating, use the gnu99 standard instead 
    # of c11, and turn off some error checking. I'm not wild about this, 
    # but if Scotch does its job, it doesn't much matter.
    set(SCOTCH_C_FLAGS ${CMAKE_C_FLAGS})
    if (NOT CMAKE_C_COMPILER_ID STREQUAL "Intel")
      string(REPLACE "c11" "gnu99" SCOTCH_C_FLAGS ${SCOTCH_C_FLAGS})
    endif()
    string(REPLACE "-pedantic-errors" "" SCOTCH_C_FLAGS ${SCOTCH_C_FLAGS})
    string(REPLACE "-Werror-implicit-function-declaration" "" SCOTCH_C_FLAGS ${SCOTCH_C_FLAGS})

    # For now, we use the "old" timing mechanism to simplify builds using 
    # older GNU compilers.
    set(SCOTCH_C_FLAGS "${SCOTCH_C_FLAGS} -DCOMMON_TIMING_OLD")

    # Respect debug flags.
    if (CMAKE_BUILD_TYPE STREQUAL "Debug")
      set(SCOTCH_C_FLAGS "${SCOTCH_C_FLAGS} -g")
    endif()

    message("Preparing scotch...")
    execute_process(COMMAND cmake -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR}/scotch ${CMAKE_CURRENT_BINARY_DIR}/scotch
                    RESULT_VARIABLE stat)
    if (NOT stat EQUAL 0)
      message(FATAL_ERROR "Copying library source failed.")
    endif()
    configure_file(
      "scotch.Makefile.inc.in"
      "${CMAKE_CURRENT_BINARY_DIR}/scotch/src/Makefile.inc"
    )

    message("Building scotch...")
    execute_process(COMMAND make ptscotch RESULT_VARIABLE stat
                    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/scotch/src
                    OUTPUT_VARIABLE scotch_build_log ERROR_VARIABLE scotch_build_errors)
    if (NOT stat EQUAL 0)
      message(FATAL_ERROR "Building scotch library failed:\n${scotch_build_errors}")
    endif()
  endif()
  file(COPY ${CMAKE_CURRENT_BINARY_DIR}/scotch/include/scotch.h DESTINATION ${PROJECT_BINARY_DIR}/include)
  file(COPY ${CMAKE_CURRENT_BINARY_DIR}/scotch/include/ptscotch.h DESTINATION ${PROJECT_BINARY_DIR}/include)
  file(COPY ${CMAKE_CURRENT_BINARY_DIR}/scotch/lib/libscotch.a DESTINATION ${PROJECT_BINARY_DIR}/lib)
  file(COPY ${CMAKE_CURRENT_BINARY_DIR}/scotch/lib/libptscotch.a DESTINATION ${PROJECT_BINARY_DIR}/lib)
  if (NOT CMAKE_INSTALL_PREFIX STREQUAL "INSTALL_DISABLED")
    install(FILES ${PROJECT_BINARY_DIR}/lib/libscotch.a ${PROJECT_BINARY_DIR}/lib/libptscotch.a DESTINATION lib)
  endif()
  set(POLYMEC_TP_LIBS ptscotch;scotch;${POLYMEC_TP_LIBS})
endif()

# Add all the libraries to the build system at large.
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${POLYMEC_TP_C_FLAGS}" PARENT_SCOPE)
set(POLYMEC_LIBRARIES ${POLYMEC_TP_LIBS};${POLYMEC_LIBRARIES} PARENT_SCOPE)
set(POLYMEC_INCDIRS ${POLYMEC_INCDIRS};${POLYMEC_TP_INCDIRS} PARENT_SCOPE)

